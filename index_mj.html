<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>chat</title>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }

      th,
      td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      mask{
        position: absolute;
        z-index: 9000;
        background-color: #000;
        display: none;
        left: 0;
        top: 0;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>MJ PROJECT</h1>
      <nav>
        <ul>
          <li>select</li>
          <li>chart</li>
          <li></li>
        </ul>
      </nav>
      <label for="inp-search">검색어 입력</label>
      <input id="inp-search" type="search">
      <button>검색어 찾기</button>
    </header>
    <main>
      <section>
        <img src="" alt="메뉴찾기">
        <h2>모두의 식단</h2>
        <strong>hello world</strong>
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ex natus asperiores quod rerum adipisci nisi voluptas eveniet qui suscipit ducimus, deleniti, repellat officia voluptatibus quam? Consectetur possimus dicta earum obcaecati?</p>
        <button type="button">회원가입</button>
        <button type="button">로그인</button>
        <aside>
          <a href="">블로그 방문하기</a>
          <a href="">인스타그램 방문하기</a>
        </aside>
      </section>
      <section>
        <h2>식단작성 메뉴얼</h2>
        <dl>
          <dt>식수일 입력</dt>
          <dd>원하는 식수일을 입력해주세요<dd>
          <dd>최소 1일 이상 입력해 주시고 최대 7일까지 입력가능합니다 <dd>
          <dt>아침/점심/저녁 설정<dd>
          <dd>원하는 시간대의 식사를 선택해주세요<dd>
          <dd>이는 보다 정확한 식단작성을 도와줍니다<dd>
          <dt>식단 형태<dd>
          <dd>원하는 식단의 유형을 선택해주세요<dd>
          <dd>이는 보다 정확한 식단작성을 도와줍니다<<dd>
          <dt>칼로리 입력<dd>
          <dd>이는 보다 정확한 식단작성을 도와줍니다<<dd>
          <dt>특이사항 입력<dd>
          <dd>알레르기, 질병이 있는 경우 작성해 주세요<dd>
          <dd>이는 보다 정확한 식단작성을 도와줍니다<dd>
        </dl>
        <figure>
          <img src="" alt="라이캣">
          <figcaption>
            <strong>균형있는 식단을 실천해보아요</strong>
            <p>하루 7잔 이상의 물을 드셨나요?</p>
          </figcaption>
        </figure>
        <figure>
          <img src="" alt="라이캣">
          <figcaption>
            <strong>좋은 식습관을 위한 식단을 짜보아요</strong>
            <p>영양소가 골고루 들어간 식단인가요?</p>
          </figcaption>
        </figure>
      </section>
      <section>
        <h2>본격적인 식단 작성</h2>
      </section>
    </main>
    <div>
      <form>
        <input type="number" id="days" placeholder="식단 일수 입력" autofocus required min="1" />
        <select id="mealType" required>
          <option value="">아침/점심/저녁 선택</option>
          <option value="아침">아침</option>
          <option value="점심">점심</option>
          <option value="저녁">저녁</option>
        </select>
        <select id="mealType2" required>
          <option value="">선택식</option>
          <option value="다이어트">다이어트</option>
          <option value="체중증가">체중증가</option>
          <option value="균형">균형</option>
        </select>
        <input type="text" id="kcal" placeholder="칼로리 입력" autofocus  />
        <input type="text" id="sign" placeholder="특이사항을 입력하세요" autofocus  />
        <button class="btn1" type="submit">전송</button>
      </form>
      <div id="answerTableContainer"></div>
    </div>
  <footer>
    <address>
      <a href="mailto: newzerto8@naver.com">newzerto8@naver.com</a>
      <a href="tel:+8201012347895">010-1234-7895</a>
    </address>
    <small>Copyright Mj Corp, All right reserved.</small>
  </footer>
    <script>
      const $form = document.querySelector("form");
      const $daysInput = document.querySelector("#days");
      const $mealTypeSelect = document.querySelector("#mealType");
      const $mealTypeSelect2 = document.querySelector("#mealType2");
      const $kcalInput = document.querySelector("#kcal");
      const $signInput = document.querySelector('#sign')
      const $answerTableContainer = document.querySelector("#answerTableContainer");

      // openAI API
      let url = `https://estsoft-openai-api.jejucodingcamp.workers.dev/`;

      // 사용자의 질문
      let question;

      //질문, 답변 저장
      let data = [
        {
        "role": "system",
        "content": "assistant는 식단표 작성 전문가이다.",
        },{
        "role": "user",
        "content": "다이어트를 위한 3일치 아침 식단을 1000~1500kcal 범위에서 작성해줘"
        },{
        "role": "assistant",
        "content": "다음과 같은 형식으로 답변을 줘. 형식 : [1DAY,['종류', '수량']*n,칼로리 합계], [2DAY,['종류', '수량']*n,칼로리 합계],[3DAY,['종류', '수량']*n,총 칼로리 합계]. 내가 질문을 하면 아래처럼 답변을 주어야 할거야. 1DAY,'현미밥 1공기','계란후라이 2개','된장국 1공기','사과 1/2개',총400kcal, 2DAY,'팬케이크 2장', '베이컨 2장', '스크램블에그 200g',총 580kcal, 3DAY,'시리얼 1보울','우유 200ml','오렌지 1개',총 380kcal"
        },{
        "role": "user",
        "content": "식단작성을 1000~1500kcal범위에서 해줘"
        },{
        "role": "assistant",
        "content": "각각의 하루치 식단을 작성한 후 마지막에 한끼당 kcal의 총합을 출력해줘"
        },{
        "role": "user",
        "content": "n일치 식단작성을 해줘"
        },{
        "role": "assistant",
        "content": "n>1일때 각각의 하루치 식단 작성 맨위에는 nDAY라고 붙여서 n일중 몇일차인지 알 수 있도록 해줘. 예를들면 user가 5일치 식단작성이라고 입력하면 너는 1일차[...] 2일차[...], 3일차[...], 4일차[...], 5일차[...] 이런식으로 user들이 알아보기 쉽도록 답변해줘."
        }
        
      ];

    data.push({
              "role": "user",
              "content": "daysInput"
          })

        data.push({
            "role": "user",
            "content": "mealTypeSelect"
        })
        data.push({
            "role": "user",
            "content": "mealTypeSelect2"
        })
        data.push({
            "role": "user",
            "content": "kcalInput"
        })
        data.push({
            "role": "user",
            "content": "mealTypeSelect"
        })
        data.push({
            "role": "user",
            "content": "signInput"
        })

// 화면에 답변 그려주는 함수
  const printAnswer = (answer) => {
  answer = answer.replace(/\([^)]*\)/g, ''); 
  // 괄호와 그 안의 내용을 제거
  let li = document.createElement("li");
  li.classList.add("answer");
  li.innerText = answer;
  

  // 답변을 테이블 형태로 출력
  const mealData = answer.split("\n");
  $answerTableContainer.innerHTML = ""; // 테이블 컨테이너 초기화

  if (mealData.length > 1) {
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tbody = document.createElement("tbody");

    // 테이블 헤더 생성
    const headerRow = document.createElement("tr");
    const dateHeader = document.createElement("th");
    const mealTypeHeader = document.createElement("th");
    const menuHeader = document.createElement("th");

    dateHeader.textContent = "메뉴";
    // mealTypeHeader.textContent = "식사";
    // menuHeader.textContent = "메뉴";

    headerRow.appendChild(dateHeader);
    headerRow.appendChild(mealTypeHeader);
    headerRow.appendChild(menuHeader);
    thead.appendChild(headerRow);

    // 테이블 내용 생성
    for (let i = 1; i < mealData.length; i++) {
      const rowData = mealData[i].split(",");
      const row = document.createElement("tr");

      for (let j = 0; j < rowData.length; j++) {
        const cell = document.createElement("td");
        cell.textContent = rowData[j].trim();
        row.appendChild(cell);
      }

      tbody.appendChild(row);
    }

    table.appendChild(thead);
    table.appendChild(tbody);
    $answerTableContainer.appendChild(table);
  }
};

//로딩중 화면
function LoadingWithMask() {
  // 화면의 높이와 너비를 구합니다.
  var maskHeight = Math.max(
    document.body.scrollHeight,
    document.documentElement.scrollHeight,
    document.body.offsetHeight,
    document.documentElement.offsetHeight,
    document.documentElement.clientHeight
  );
  var maskWidth = Math.max(
    document.body.scrollWidth,
    document.documentElement.scrollWidth,
    document.body.offsetWidth,
    document.documentElement.offsetWidth,
    document.documentElement.clientWidth
  );

  // 화면에 출력할 마스크를 설정해줍니다.
  var mask = document.createElement('div');
  mask.id = 'mask';
  mask.style.position = 'absolute';
  mask.style.zIndex = '9000';
  mask.style.backgroundColor = '#000000';
  mask.style.display = 'none';
  mask.style.left = '0';
  mask.style.top = '0';

  var loadingImg = document.createElement('div');
  loadingImg.id = 'loadingImg';
  loadingImg.innerHTML =
    "<img src='LoadingImg.gif' style='position: relative; display: block; margin: 0px auto;'/>";

  var loadingTxt = document.createElement('div');loadingTxt.id = 'loadingTxt';
  loadingTxt.innerHTML='입력하신 정보로 식단을 작성중 입니다';
  loadingTxt.style.color = 'gray'
  loadingTxt.style.fontSize = '20px'
  loadingTxt.style.textAlign = 'center'



  // 화면에 레이어 추가
  document.body.appendChild(mask);
  document.body.appendChild(loadingImg);
  document.body.appendChild(loadingTxt);

  // 마스크의 높이와 너비를 화면에 맞춰 전체 화면을 채웁니다.
  mask.style.width = maskWidth + 'px';
  mask.style.height = maskHeight + 'px';
  mask.style.opacity = '0.3';

  // 마스크 표시
  // mask.style.display = 'block';

  // 로딩중 이미지 표시
  loadingImg.style.display = 'block';
  loadingTxt.style.display = 'block';
}

function closeLoadingWithMask() {
            var mask = document.getElementById('mask');
            var loadingImg = document.getElementById('loadingImg');
            var loadingTxt = document.getElementById('loadingTxt');

            if (mask && loadingImg && loadingTxt) {
              mask.style.display = 'none';
              loadingImg.style.display = 'none';
              loadingTxt.style.display = 'none';
              mask.parentNode.removeChild(mask);
              loadingImg.parentNode.removeChild(loadingImg);
              loadingTxt.parentNode.removeChild(loadingTxt);
            }
          }

      // api 요청보내는 함수
      const apiPost = async (data) => {
        LoadingWithMask();
        const result = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
          redirect: "follow",
        })
          .then((res) => res.json())
          .then((res) => {
            closeLoadingWithMask()
            printAnswer(res.choices[0].message.content);
          })
          .catch((err) => {
            console.log(err);
          });
      };
      
      // submit
      $form.addEventListener("submit", (e) => {
        e.preventDefault();
        const days = $daysInput.value;
        const kcal = $kcalInput.value;
        const sign = $signInput.value;
        const mealType = $mealTypeSelect.value;
        const mealType2 = $mealTypeSelect2.value;
        if (days && mealType && mealType2 && kcal ) {
          $daysInput.value = null;
          $kcalInput.value = null;
          $signInput.value = null;
          $mealTypeSelect.value = "";
          $mealTypeSelect2.value = "";

          question = ` ${mealType2}를 위한 ${days}일치  ${mealType} 식단을 ${kcal}kcal 범위에서 짜줘 특이사항은 ${sign}이 있어, 내가 원하는 형태는 설명이 없고, 레시피가 아닌 식단으로만 구성된 형태야`;
          data.push({ role: "user", content: question });
          apiPost(data)
        }
      });
    </script>
  </body>
</html>
